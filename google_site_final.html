<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quran Quiz Embed</title>
    
    <!-- 1. Load Library CSS (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. Load Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- 3. Load React & Babel secara Global (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      /* Reset dasar untuk iframe */
      html, body, #root { 
        height: 100%; 
        margin: 0; 
        padding: 0; 
        background-color: #f8fafc;
        overflow-x: hidden;
      }
      body { font-family: 'Nunito', sans-serif; }
      .font-arabic { font-family: 'Amiri', serif; }
      
      /* Scrollbar halus */
      ::-webkit-scrollbar { width: 4px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      
      /* Animasi sederhana */
      @keyframes pulse-slow {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.8; transform: scale(0.98); }
      }
      .animate-pulse-slow { animation: pulse-slow 2s infinite; }
    </style>
</head>
<body>
    <!-- Tempat Error Handling Global -->
    <div id="error-display" style="display:none; padding: 20px; background: #fee2e2; color: #991b1b; font-size: 12px; border-bottom: 1px solid #ef4444;">
        <strong>Terjadi Kesalahan:</strong> <span id="error-message"></span>
        <br/>
        <button onclick="window.location.reload()" style="margin-top:10px; padding:5px 10px; background:#fff; border:1px solid #991b1b; border-radius:4px;">Muat Ulang</button>
    </div>

    <div id="root"></div>

    <script>
        // Global Error Handler agar user tahu jika script crash
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-message').textContent = msg;
            console.error("App Error:", msg, error);
            return false;
        };
    </script>

    <script type="text/babel">
        // ==========================================
        // 1. KONFIGURASI
        // ==========================================
        // Pastikan API Key ini benar. Jika API Key salah, soal akan otomatis beralih ke mode offline (fallback).
        const API_KEY = "AIzaSyBNPTKt4j88rArFwfFo5SnaiSUbXfGespY"; 

        const { useState, useEffect, useRef } = React;

        // ==========================================
        // 2. ICONS (SVG)
        // ==========================================
        const Icons = {
            Search: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path strokeLinecap="round" strokeLinejoin="round" d="m21 21-4.3-4.3"/></svg>,
            Grid: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M4 6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6zM14 6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2V6zM4 16a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2zM14 16a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2z"/></svg>,
            Mic: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5m-12 0v1.5a6 6 0 0 0 6 6m0 0v3.75m3-3.75h-6"/></svg>,
            Book: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25"/></svg>,
            Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="3" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="m4.5 12.75 6 6 9-13.5"/></svg>,
            X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="3" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12"/></svg>,
            Volume: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z"/></svg>,
            Mute: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6 4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z"/></svg>,
            Star: ({fill}) => <svg className={`w-8 h-8 ${fill ? 'text-yellow-400 fill-yellow-400' : 'text-emerald-800'}`} viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.563.563 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.563.563 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" /></svg>
        };

        // ==========================================
        // 3. AUDIO SYSTEM (SAFE MODE)
        // ==========================================
        const audioManager = {
            ctx: null,
            isMuted: false,
            
            // Inisialisasi hanya saat user klik (User Gesture)
            init: function() {
                if (!this.ctx) {
                    try {
                        const CtxClass = window.AudioContext || window.webkitAudioContext;
                        if (CtxClass) {
                            this.ctx = new CtxClass();
                        }
                    } catch (e) {
                        console.warn("Audio tidak didukung browser ini:", e);
                    }
                }
                if (this.ctx && this.ctx.state === 'suspended') {
                    this.ctx.resume().catch(e => console.log("Resume audio failed", e));
                }
            },

            play: function(type) {
                if (this.isMuted || !this.ctx) return;
                try {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    
                    const now = this.ctx.currentTime;
                    
                    if (type === 'click') {
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(800, now);
                        gain.gain.setValueAtTime(0.05, now);
                        osc.start(now);
                        osc.stop(now + 0.05);
                    } else if (type === 'correct') {
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(523.25, now); // C5
                        gain.gain.setValueAtTime(0.1, now);
                        osc.start(now);
                        osc.stop(now + 0.1);
                        
                        const osc2 = this.ctx.createOscillator();
                        const gain2 = this.ctx.createGain();
                        osc2.frequency.setValueAtTime(783.99, now + 0.1); // G5
                        gain2.gain.setValueAtTime(0.1, now + 0.1);
                        osc2.connect(gain2);
                        gain2.connect(this.ctx.destination);
                        osc2.start(now + 0.1);
                        gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                        osc2.stop(now + 0.3);
                    } else if (type === 'wrong') {
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, now);
                        gain.gain.setValueAtTime(0.1, now);
                        osc.start(now);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                        osc.stop(now + 0.3);
                    }

                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                } catch (e) {
                    console.error("Play audio error", e);
                }
            }
        };

        // ==========================================
        // 4. LOGIC GENERATE SOAL
        // ==========================================
        async function fetchQuestions(mode) {
            // Fallback Data (Offline Mode)
            const fallbackQuestions = [
                {
                    id: "f1",
                    type: "GUESS_SURAH",
                    questionText: "Potongan ayat berikut terdapat dalam surat apa?",
                    arabicText: "إِنَّا أَعْطَيْنَاكَ الْكَوْثَرَ",
                    options: ["Al-Ikhlas", "Al-Kautsar", "Al-Ma'un", "An-Nasr"],
                    correctAnswer: "Al-Kautsar",
                    points: 10
                },
                {
                    id: "f2",
                    type: "COMPLETE_VERSE",
                    questionText: "Lengkapi ayat berikut:",
                    versePart1: "قُلْ هُوَ ٱللَّهُ",
                    hiddenPart: "أَحَدٌ",
                    versePart2: "",
                    options: ["أَحَدٌ", "الصَّمَدُ", "يُولَدْ", "كُفُوًا"],
                    points: 10
                }
            ];

            if (!API_KEY || API_KEY.includes("GANTI")) {
                return fallbackQuestions;
            }

            try {
                const prompt = `
                    Buatkan 5 soal kuis Al-Quran singkat untuk anak sekolah. 
                    Mode: ${mode}. Output JSON only.
                    Schema: {
                      "questions": [{
                        "id": "1",
                        "type": "GUESS_SURAH" or "COMPLETE_VERSE",
                        "questionText": "Indonesian question",
                        "arabicText": "Arabic text if needed",
                        "versePart1": "part 1 if complete verse",
                        "hiddenPart": "hidden answer if complete verse",
                        "versePart2": "part 2 if complete verse",
                        "options": ["A","B","C","D"],
                        "correctAnswer": "Correct String"
                      }]
                    }
                `;

                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!res.ok) throw new Error("API Error");

                const data = await res.json();
                const rawText = data.candidates[0].content.parts[0].text;
                const jsonStr = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const parsed = JSON.parse(jsonStr);
                
                return parsed.questions.map(q => ({ ...q, points: 10 }));
            } catch (e) {
                console.log("Menggunakan mode offline karena:", e);
                return fallbackQuestions;
            }
        }

        // ==========================================
        // 5. MAIN COMPONENT
        // ==========================================
        const App = () => {
            const [view, setView] = useState('MENU'); // MENU, LOADING, PLAY, RESULT
            const [questions, setQuestions] = useState([]);
            const [idx, setIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [correct, setCorrect] = useState(0);
            const [muted, setMuted] = useState(false);
            const [initializing, setInitializing] = useState(true);

            // Cek dimensi layar untuk responsive debug
            useEffect(() => {
                setInitializing(false);
            }, []);

            const start = async (mode) => {
                audioManager.init(); // Init audio context on user gesture!
                audioManager.play('click');
                setView('LOADING');
                const q = await fetchQuestions(mode);
                setQuestions(q);
                setIdx(0);
                setScore(0);
                setCorrect(0);
                setView('PLAY');
            };

            const answer = (isCorrect) => {
                if (isCorrect) {
                    setScore(s => s + 10);
                    setCorrect(c => c + 1);
                    audioManager.play('correct');
                } else {
                    audioManager.play('wrong');
                }

                if (idx < questions.length - 1) {
                    setTimeout(() => setIdx(i => i + 1), 1000);
                } else {
                    setTimeout(() => setView('RESULT'), 1000);
                }
            };

            // --- RENDERERS ---

            if (view === 'MENU') {
                return (
                    <div className="flex flex-col items-center justify-center min-h-full p-4">
                        <div className="text-center mb-6">
                            <h1 className="text-3xl font-extrabold text-emerald-800 mb-1">Quran Quiz</h1>
                            <p className="text-slate-500 text-sm">Pilih tantanganmu</p>
                        </div>
                        
                        <div className="w-full max-w-sm space-y-3">
                            <MenuButton 
                                icon={<Icons.Search />} 
                                title="Tebak Surat" 
                                desc="Tebak nama surat" 
                                color="emerald"
                                onClick={() => start('TEBAK_SURAT')} 
                            />
                            <MenuButton 
                                icon={<Icons.Grid />} 
                                title="Lengkapi Ayat" 
                                desc="Sambung ayat" 
                                color="amber"
                                onClick={() => start('LENGKAPI_AYAT')} 
                            />
                            <MenuButton 
                                icon={<Icons.Mic />} 
                                title="Tajwid" 
                                desc="Hukum bacaan" 
                                color="blue"
                                onClick={() => start('ILMU_TAJWID')} 
                            />
                            <MenuButton 
                                icon={<Icons.Book />} 
                                title="Arti Kata" 
                                desc="Terjemah" 
                                color="purple"
                                onClick={() => start('ARTI_KATA')} 
                            />
                        </div>
                    </div>
                );
            }

            if (view === 'LOADING') {
                return (
                    <div className="flex flex-col items-center justify-center h-full min-h-[300px]">
                        <div className="w-10 h-10 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mb-3"></div>
                        <p className="text-emerald-700 font-bold animate-pulse">Menyiapkan Soal...</p>
                    </div>
                );
            }

            if (view === 'RESULT') {
                const percent = Math.round((score / (questions.length * 10)) * 100);
                return (
                    <div className="flex flex-col items-center justify-center min-h-full p-6 text-center">
                        <div className="bg-white rounded-3xl shadow-lg p-8 w-full max-w-sm border border-slate-100">
                            <h2 className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Skor Akhir</h2>
                            <div className="text-5xl font-black text-emerald-600 mb-4">{percent}</div>
                            <div className="flex justify-center gap-2 mb-6">
                                <Icons.Star fill={percent >= 30} />
                                <Icons.Star fill={percent >= 60} />
                                <Icons.Star fill={percent >= 90} />
                            </div>
                            <div className="bg-slate-50 rounded-xl p-3 mb-6 text-sm text-slate-600">
                                "Sebaik-baik kalian adalah yang belajar Al-Quran dan mengajarkannya."
                            </div>
                            <button onClick={() => setView('MENU')} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700">
                                Main Lagi
                            </button>
                        </div>
                    </div>
                );
            }

            // PLAYING
            const q = questions[idx];
            return (
                <div className="flex flex-col min-h-full max-w-md mx-auto bg-white md:shadow-lg md:my-4 md:rounded-xl overflow-hidden">
                    {/* Header Play */}
                    <div className="h-14 border-b border-slate-100 flex items-center justify-between px-4 bg-white sticky top-0 z-10">
                        <button onClick={() => setView('MENU')} className="text-slate-400 font-bold text-sm">Keluar</button>
                        <span className="bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full text-xs font-bold">Soal {idx + 1}/{questions.length}</span>
                        <button onClick={() => { audioManager.isMuted = !muted; setMuted(!muted); }}>
                            {muted ? <div className="text-slate-300"><Icons.Mute /></div> : <div className="text-emerald-500"><Icons.Volume /></div>}
                        </button>
                    </div>

                    {/* Content */}
                    <div className="flex-1 p-4 overflow-y-auto">
                        <h2 className="text-lg font-bold text-slate-800 mb-4 text-center">{q.questionText}</h2>
                        
                        {/* Arabic Card */}
                        {(q.arabicText || q.versePart1) && (
                            <div className="bg-emerald-50 border border-emerald-100 rounded-2xl p-6 text-center mb-6">
                                <p className="font-arabic text-2xl md:text-3xl leading-loose text-emerald-900" dir="rtl">
                                    {q.versePart1}
                                    {q.type === 'COMPLETE_VERSE' ? <span className="mx-1 text-emerald-400">...</span> : q.arabicText}
                                    {q.versePart2}
                                </p>
                            </div>
                        )}

                        {/* Options */}
                        <div className="space-y-3">
                            {q.options.map((opt, i) => (
                                <OptionButton 
                                    key={i} 
                                    text={opt} 
                                    correct={opt === (q.correctAnswer || q.hiddenPart)}
                                    onAnswer={answer}
                                />
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- SUB COMPONENTS ---
        
        const MenuButton = ({ icon, title, desc, color, onClick }) => {
            const colors = {
                emerald: "bg-emerald-50 text-emerald-600 border-emerald-100 hover:border-emerald-500",
                amber: "bg-amber-50 text-amber-600 border-amber-100 hover:border-amber-500",
                blue: "bg-blue-50 text-blue-600 border-blue-100 hover:border-blue-500",
                purple: "bg-purple-50 text-purple-600 border-purple-100 hover:border-purple-500",
            };
            const c = colors[color] || colors.emerald;

            return (
                <button onClick={onClick} className={`w-full flex items-center gap-4 p-4 rounded-xl border-2 bg-white transition-all active:scale-95 text-left ${c.split(' ')[3]}`}>
                    <div className={`p-3 rounded-lg ${c.split(' ').slice(0,2).join(' ')}`}>
                        {icon}
                    </div>
                    <div>
                        <div className="font-bold text-slate-800 text-base">{title}</div>
                        <div className="text-slate-400 text-xs">{desc}</div>
                    </div>
                </button>
            );
        };

        const OptionButton = ({ text, correct, onAnswer }) => {
            const [status, setStatus] = useState('idle'); // idle, correct, wrong
            
            const handleClick = () => {
                if(status !== 'idle') return;
                const s = correct ? 'correct' : 'wrong';
                setStatus(s);
                // Parent callback after delay
                setTimeout(() => onAnswer(correct), 800);
            };

            // Reset status when prop text changes (new question)
            useEffect(() => { setStatus('idle'); }, [text]);

            let baseClass = "w-full p-4 rounded-xl border-2 text-lg font-arabic font-semibold transition-all flex justify-between items-center text-right ";
            if (status === 'idle') baseClass += "bg-white border-slate-100 text-slate-700 hover:border-emerald-300 hover:bg-emerald-50";
            if (status === 'correct') baseClass += "bg-emerald-500 border-emerald-500 text-white";
            if (status === 'wrong') baseClass += "bg-red-500 border-red-500 text-white";

            return (
                <button onClick={handleClick} className={baseClass} dir="rtl">
                    <span>{text}</span>
                    {status === 'correct' && <Icons.Check />}
                    {status === 'wrong' && <Icons.X />}
                </button>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>